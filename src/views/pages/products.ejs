<%- include('../partials/header') %>
<h2>Products</h2>
<form method="get" action="/products">
  <label>Filter by category</label>
  <select name="category">
    <option value="">All</option>
    <option value="sportswear">Sportswear</option>
    <option value="training">Training</option>
    <option value="recovery">Recovery</option>
    <option value="nutrition">Nutrition</option>
  </select>
  <button>Apply filter</button>
</form>

<% if (session && session.role === 'admin') { %>
  <div class="card">
    <h3>Admin: Create New Product</h3>
    <form id="create-product-form">
      <input name="name" placeholder="Product name" required />
      <select name="category" required>
        <option value="sportswear">sportswear</option>
        <option value="training">training</option>
        <option value="recovery">recovery</option>
        <option value="nutrition">nutrition</option>
      </select>
      <input name="subCategory" placeholder="Subcategory" required />
      <input name="price" type="number" step="0.01" min="0" placeholder="Price" required />
      <input name="stock" type="number" min="0" placeholder="Stock" required />
      <textarea name="description" placeholder="Description"></textarea>
      <button type="submit">Create product</button>
    </form>
  </div>
<% } %>

<div class="grid">
  <% products.forEach((p) => { %>
    <div class="card">
      <span class="badge"><%= p.subCategory %></span>
      <h3><a href="/products/<%= p._id %>"><%= p.name %></a></h3>
      <p>$<%= p.price.toFixed(2) %> | Stock: <%= p.stock %></p>

      <% if (session && session.role === 'admin') { %>
        <details>
          <summary>Admin actions</summary>
          <form class="update-product-form" data-product-id="<%= p._id %>">
            <input name="name" value="<%= p.name %>" required />
            <input name="subCategory" value="<%= p.subCategory %>" required />
            <input name="price" type="number" step="0.01" min="0" value="<%= p.price %>" required />
            <input name="stock" type="number" min="0" value="<%= p.stock %>" required />
            <textarea name="description"><%= p.description %></textarea>
            <button type="submit">Update product</button>
          </form>
          <button class="delete-product secondary" data-product-id="<%= p._id %>">Delete product</button>
        </details>
      <% } %>
    </div>
  <% }) %>
</div>

<% if (session && session.role === 'admin') { %>
<script>
  document.getElementById('create-product-form').addEventListener('submit', async (event) => {
    event.preventDefault();
    const payload = Object.fromEntries(new FormData(event.target).entries());
    payload.price = Number(payload.price);
    payload.stock = Number(payload.stock);

    const response = await fetch('/api/products', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (response.ok) {
      alert('Product created');
      window.location.reload();
    } else {
      const json = await response.json();
      alert(json.message || 'Could not create product');
    }
  });

  document.querySelectorAll('.update-product-form').forEach((form) => {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const productId = form.dataset.productId;
      const payload = Object.fromEntries(new FormData(form).entries());
      payload.price = Number(payload.price);
      payload.stock = Number(payload.stock);

      const response = await fetch(`/api/products/${productId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        alert('Product updated');
        window.location.reload();
      } else {
        const json = await response.json();
        alert(json.message || 'Could not update product');
      }
    });
  });

  document.querySelectorAll('.delete-product').forEach((button) => {
    button.addEventListener('click', async () => {
      const productId = button.dataset.productId;
      const response = await fetch(`/api/products/${productId}`, { method: 'DELETE' });

      if (response.ok) {
        alert('Product deleted');
        window.location.reload();
      } else {
        const json = await response.json();
        alert(json.message || 'Could not delete product');
      }
    });
  });
</script>
<% } %>

<%- include('../partials/footer') %>
